@model Dao.Model.UserFromVk

@section Script
{
    <script>
        var i = 0;
        var ids;
        var url = "@Url.Action("DownloadUserFromVk")";

        $(document).ready(function () {
            $("#wait").hide();

            $("#downloadUser").click(function () {
                $("#wait").show();
                var vkId = $("#VkId").val();
                $("#result").text("");
                //$("#friends").text("");
                SaveUser(vkId, false);
            });

            $("#downloadAllUser").click(function () {
                $("#wait").show();
                $("#result").text("");
                var vkId = $("#VkId").val();

                ids = $("#friends").children();
                SaveUser(vkId, true);
            });
        });

        function SaveUser(vkId, downloadFriend) {

            $.when(
                $.get(url, { vkUserId: vkId }).done(function(data, status) {
                    SaveResult(data, vkId);
                })
            ).then(function (data, textStatus, jqXHR) {
                if (downloadFriend) SaveNext();
            });

            
        }

        function SaveNext() {
            if (i >= ids.length) {
                $("#wait").hide();
                return;
            }
            
            var id = ids[i++].innerHTML;
            SaveUser(id, true);
        }

        function SaveResult(data, vkId) {
            //var mess = $("#result").text();
            if (data.isAlreadyExists) {
                $("#" + vkId).attr("style", "background-color: #FFE849;");
                return;
            }

            if (data.isSuccessful) {
                //mess += data.content + " was saved ";
                $("#" + vkId).attr("style", "background-color: #00FFAB;");
            } else {
                //mess += " Somesing fail*** ";
                $("#" + vkId).attr("style", "background-color: #FF4961;");
            }

            //$("#result").text(mess);
        }
    </script>
}

@{
    ViewBag.Title = "Create user";
    Layout = "../LayoutMaster.cshtml";
}

<h2>Add User</h2>

<input id="downloadUser" type="button" value="Download one user to my base" />
<input id="downloadAllUser" type="button" value="Download this user AND His friedns to my base" />

<div><img id="wait" src="@Url.Content("~/Content/wait.gif")" /></div>

@using (Html.BeginForm("AddUser", "Home", FormMethod.Post))
{
    <input type="submit" value="Get" />
    <p>Id @Html.TextBoxFor(x => x.VkId)</p>
    <p id="result">@(Model != null ? Html.Raw(Model.FirstName + Model.LastName) : null)</p>
    if (Model != null && Model.FriendIds != null)
    {
        <p id="friends">
            @foreach (var f in Model.FriendIds)
            {
                <span id="@f.FriendsId" style="margin-left: 10px;">@f.FriendsId</span>
            }
        </p>
    }
    
}

